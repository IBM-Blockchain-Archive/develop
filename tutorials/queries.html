<!--
 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
<!doctype html>
<html lang="en">
<!--
 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
  
  
  

<head>
  <meta charset="utf-8">
  
    <title>Queries Tutorial | Hyperledger Composer</title>
  
  <meta name="viewport" content="width=device-width">
  <link rel="icon" type="image/x-icon" href="/develop/favicon.ico">
  <meta name="google-site-verification" content="fBQRJ6h7MV7_TJ7grbgq4P-d-07NRfDWPe4pqEEoH5w">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  

  
    <link href="/develop/assets/css/normalize.css" rel="stylesheet">
    <link href="/develop/assets/css/new-style.min.css" rel="stylesheet">
    <link href="/develop/assets/css/grid-layout.min.css" rel="stylesheet">
    <link href="/develop/assets/css/duo.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.6.0/clipboard.min.js"></script>
  

  
</head>


<body class="">

  
  <!-- % include navbar.html % -->
  

  <div class="SiteWrapper">
    
      <!--
 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
-->
<div class="content">
    <article class="docs-container">
        <!-- If there's a sidebar, divide into 2 columns -->
        
        <div class="page-sidebar-grid" id="off-canvas">
          <!-- <a class="toggle close" href="#">close</a> -->
          <div class="docs-pagenav-grid">
            <!-- Navigation -->
  <nav class="navbar-docs" role="navigation">
        <!-- Just show the product name -->
            <p class="navbar-brand">IBM Blockchain Platform: <b>Develop</b></p>

</nav>

          </div>

          <select id="version" name="version" onchange="location = this.options[this.selectedIndex].value;">
              <option>Select version</option>
              <option value="/composer/latest/introduction/introduction.html" title="The most stable version of Composer">Latest</option>
              <option value="/composer/unstable/introduction/introduction.html" title="The version that will replace Latest">Latest-unstable</option>
          </select>

            <div class="search-form">
              <form action="/develop/search/search.html" method="get">
                <!-- <label for="search-box">Search</label> -->

                <input type="text" id="search-box"  class="search-box" name="query" placeholder="Search here...">
                <input type="submit" class="submit-input hide" value="">

                <div class="search-icon">
                  <img src="/develop/assets/img/Search_Icon_1.svg" class="trigger" type="submit">
                </div>
              </form>
            </div>

          <div class="docs-current-page-grid">
          <p>Queries Tutorial</p>
          </div>

          <nav class="context-nav">
            
            
              <ul>
<li><p><a href="/develop/"><b>Introduction</b><img src="/develop/assets/img/Caret_SW_2.svg" class="caret"></a></p>

<ul>
<li><a href="/develop/introduction/key-concepts">Key Concepts</a></li>
<li><a href="/develop/introduction/solution-architecture">Typical Solution Architecture</a></li>
</ul></li>
<li><p><a href="/develop/installing/installing-index"><b>Installing</b><img src="/develop/assets/img/Caret_SW_2.svg" class="caret"></a></p>

<ul>
<li><a href="/develop/installing/installing-prereqs">Installing pre-requisites</a></li>
<li><a href="/develop/installing/development-tools">Installing the development environment</a></li>
<li><a href="/develop/installing/update-dev-env">Updating the development environment</a></li>
<li><a href="/develop/installing/uninstall-dev-env">Uninstalling the development environment</a></li>
</ul></li>
<li><p><a href="/develop/tutorials/tutorials"><b>Tutorials</b><img src="/develop/assets/img/Caret_SW_2.svg" class="caret"></a></p>

<ul>
<li><a href="/develop/tutorials/playground-tutorial">Playground Tutorial</a></li>
<li><a href="/develop/tutorials/developer-tutorial">Developer Tutorial</a></li>
<li><a href="/develop/tutorials/queries">Queries Tutorial</a></li>
<li><a href="/develop/tutorials/deploy-to-fabric-single-org">Deploying to a single organization Hyperledger Fabric</a></li>
<li><a href="/develop/tutorials/deploy-to-fabric-multi-org">Deploying to a multi-organization Hyperledger Fabric</a></li>
<li><a href="/develop/tutorials/invoke-composer-network">Interacting with other business networks</a></li>
<li><a href="/develop/tutorials/acl-trading">Access Control Tutorial - Commodity Trading</a></li>
<li><a href="/develop/tutorials/google_oauth2_rest">Using Google OAUTH2.0 with a Composer REST server</a></li>
</ul></li>
<li><p><a href="/develop/playground/playground-index"><b>Using Playground</b><img src="/develop/assets/img/Caret_SW_2.svg" class="caret"></a></p>

<ul>
<li><a href="/develop/playground/id-cards-playground">Business Network Cards</a></li>
</ul></li>
<li><p><a href="/develop/business-network/business-network-index"><b>Developing Business Networks</b><img src="/develop/assets/img/Caret_SW_2.svg" class="caret"></a></p>

<ul>
<li><a href="/develop/business-network/businessnetworkdefinition">Business Network Definitions</a></li>
<li><a href="/develop/business-network/bnd-create">Create a Business Network Definition</a></li>
<li><a href="/develop/business-network/bnd-deploy">Deploying Business Networks</a></li>
<li><a href="/develop/business-network/publishing-events">Emitting Events</a></li>
<li><a href="/develop/business-network/testing">Testing Business Networks</a></li>
<li><a href="/develop/business-network/bnd-publish">Publish Models or Business Network Definitions</a></li>
<li><a href="/develop/business-network/upgrading-bna">Upgrading a deployed business network</a></li>
<li><a href="/develop/business-network/query">Using Queries and Filters with Business Network Data</a></li>
<li><a href="/develop/business-network/programmatic-access-control">Programmatic access control</a></li>
<li><a href="/develop/business-network/historian">Hyperledger Composer Historian</a></li>
<li><a href="/develop/business-network/cloud-wallets">Customising card stores</a></li>
</ul></li>
<li><p><a href="/develop/applications/applications-index"><b>Developing Applications</b><img src="/develop/assets/img/Caret_SW_2.svg" class="caret"></a></p>

<ul>
<li><a href="/develop/applications/node">Writing a Node.js application</a></li>
<li><a href="/develop/applications/web">Writing Web applications</a></li>
<li><a href="/develop/applications/subscribing-to-events">Subscribing to events</a></li>
</ul></li>
<li><p><a href="/develop/integrating/integrating-index"><b>Integrating Existing Systems</b><img src="/develop/assets/img/Caret_SW_2.svg" class="caret"></a></p>

<ul>
<li><a href="/develop/integrating/getting-started-rest-api">Generating a REST API</a></li>
<li><a href="/develop/integrating/publishing-events">Publishing events from the REST server</a></li>
<li><a href="/develop/integrating/enabling-rest-authentication">Enabling authentication for the REST server</a></li>
<li><a href="/develop/integrating/enabling-multiuser">Enabling multiple user mode for the REST server</a></li>
<li><a href="/develop/integrating/securing-the-rest-server">Securing the REST server using HTTPS and TLS</a></li>
<li><a href="/develop/integrating/deploying-the-rest-server">Deploying the REST server for a business network</a></li>
<li><a href="/develop/integrating/node-red">Integrating with Node-RED</a></li>
<li><a href="/develop/integrating/call-out">Calling external HTTP or REST services</a></li>
</ul></li>
<li><p><a href="/develop/managing/managingindex"><b>Managing a Deployed Business Network</b><img src="/develop/assets/img/Caret_SW_2.svg" class="caret"></a></p>

<ul>
<li><a href="/develop/managing/participantsandidentities">Participants and identities</a></li>
<li><a href="/develop/managing/participant-add">Adding participants</a></li>
<li><a href="/develop/managing/id-cards-playground">Creating, Exporting, and Importing Business Network Cards</a></li>
<li><a href="/develop/managing/identity-issue">Issuing a new identity to a participant</a></li>
<li><a href="/develop/managing/identity-bind">Binding an existing identity to a participant</a></li>
<li><a href="/develop/managing/identity-list">Listing all identities in a business network</a></li>
<li><a href="/develop/managing/identity-revoke">Revoking an identity from a participant</a></li>
<li><a href="/develop/managing/connector-information">Interacting with Hyperledger Fabric</a></li>
</ul></li>
<li><p><a href="/develop/problems/diagnostics"><b>Diagnosing Problems</b><img src="/develop/assets/img/Caret_SW_2.svg" class="caret"></a></p></li>
<li><p><a href="/develop/reference/reference-index"><b>Reference</b><img src="/develop/assets/img/Caret_SW_2.svg" class="caret"></a></p>

<ul>
<li><a href="/develop/reference/MeetTheModules">Hyperledger Composer npm Modules</a></li>
<li><a href="/develop/reference/cto_language">Modeling Language</a></li>
<li><a href="/develop/reference/acl_language">Access Control Language</a></li>
<li><a href="/develop/reference/query-language">Query Language</a></li>
<li><a href="/develop/reference/model-compatibility">Model Compatibility</a></li>
<li><a href="/develop/reference/connectionprofile">Connection Profiles</a></li>
<li><a href="/develop/reference/js_scripts">Transaction Processor Functions</a></li>
<li><a href="/develop/reference/commands">Hyperledger Composer CLI Commands</a></li>
<li><a href="/develop/reference/rest-server">Hyperledger Composer REST Server</a></li>
<li><a href="/develop/reference/glossary">Hyperledger Composer Glossary of Terms</a></li>
</ul></li>
<li><p><a href="/develop/support/support-index"><b>Support</b><img src="/develop/assets/img/Caret_SW_2.svg" class="caret"></a></p></li>
<li><p><a href="/develop/api/api-doc-index"><b>API Reference</b><img src="/develop/assets/img/Caret_SW_2.svg" class="caret"></a></p>

<ul>
<li><a href="/develop/api/allData">API Class Index</a></li>
<li><a href="/develop/api/admin-adminconnection">AdminConnection (Admin API)</a></li>
<li><a href="/develop/api/client-assetregistry">AssetRegistry (Client API)</a></li>
<li><a href="/develop/api/client-businessnetworkconnection">BusinessNetworkConnection (Client API)</a></li>
<li><a href="/develop/api/client-historian">Historian (Client API)</a></li>
<li><a href="/develop/api/client-identityregistry">IdentityRegistry (Client API)</a></li>
<li><a href="/develop/api/client-participantregistry">ParticipantRegistry (Client API)</a></li>
<li><a href="/develop/api/client-query">Query (Client API)</a></li>
<li><a href="/develop/api/client-registry">Registry (Client API)</a></li>
<li><a href="/develop/api/client-transactionregistry">TransactionRegistry (Client API)</a></li>
<li><a href="/develop/api/common-assetdeclaration">AssetDeclaration (Common API)</a></li>
<li><a href="/develop/api/common-businessnetworkcardstore">BusinessNetworkCardStore (Common API)</a></li>
<li><a href="/develop/api/common-businessnetworkdefinition">BusinessNetworkDefinition (Common API)</a></li>
<li><a href="/develop/api/common-businessnetworkmetadata">BusinessNetworkMetadata (Common API)</a></li>
<li><a href="/develop/api/common-classdeclaration">ClassDeclaration (Common API)</a></li>
<li><a href="/develop/api/common-conceptdeclaration">ConceptDeclaration (Common API)</a></li>
<li><a href="/develop/api/common-concept">Concept (Common API)</a></li>
<li><a href="/develop/api/common-enumdeclaration">EnumDeclaration (Common API)</a></li>
<li><a href="/develop/api/common-enumvaluedeclaration">EnumValueDeclaration (Common API)</a></li>
<li><a href="/develop/api/common-eventdeclaration">EventDeclaration (Common API)</a></li>
<li><a href="/develop/api/common-factory">Factory (Common API)</a></li>
<li><a href="/develop/api/common-functiondeclaration">FunctionDeclaration (Common API)</a></li>
<li><a href="/develop/api/common-idcard">IdCard (Common API)</a></li>
<li><a href="/develop/api/common-identifiable">Identifiable (Common API)</a></li>
<li><a href="/develop/api/common-introspector">Introspector (Common API)</a></li>
<li><a href="/develop/api/common-modelfile">ModelFile (Common API)</a></li>
<li><a href="/develop/api/common-modelmanager">ModelManager (Common API)</a></li>
<li><a href="/develop/api/common-participantdeclaration">ParticipantDeclaration (Common API)</a></li>
<li><a href="/develop/api/common-property">Property (Common API)</a></li>
<li><a href="/develop/api/common-relationshipdeclaration">RelationshipDeclaration (Common API)</a></li>
<li><a href="/develop/api/common-relationship">Relationship (Common API)</a></li>
<li><a href="/develop/api/common-resource">Resource (Common API)</a></li>
<li><a href="/develop/api/common-serializer">Serializer (Common API)</a></li>
<li><a href="/develop/api/common-transactiondeclaration">TransactionDeclaration (Common API)</a></li>
<li><a href="/develop/api/common-typed">Typed (Common API)</a></li>
<li><a href="/develop/api/common-validatedconcept">ValidatedConcept (Common API)</a></li>
<li><a href="/develop/api/common-validatedresource">ValidatedResource (Common API)</a></li>
<li><a href="/develop/api/runtime-api">Api (Runtime API)</a></li>
<li><a href="/develop/api/runtime-assetregistry">AssetRegistry (Runtime API)</a></li>
<li><a href="/develop/api/runtime-factory">Factory (Runtime API)</a></li>
<li><a href="/develop/api/runtime-participantregistry">ParticipantRegistry (Runtime API)</a></li>
<li><a href="/develop/api/runtime-query">Query (Runtime API)</a></li>
<li><a href="/develop/api/runtime-serializer">Serializer (Runtime API)</a></li>
</ul></li>
<li><p><a href="/develop/systemns/systemns-index"><b>System Namespace Reference</b><img src="/develop/assets/img/Caret_SW_2.svg" class="caret"></a></p>

<ul>
<li><a href="/develop/systemns/01_summary">Summary</a></li>
<li><a href="/develop/systemns/02_assets">Assets</a></li>
<li><a href="/develop/systemns/03_participants">Participants</a></li>
<li><a href="/develop/systemns/04_transactions">Transactions</a></li>
<li><a href="/develop/systemns/05_events">Events</a></li>
<li><a href="/develop/systemns/06_enums">Enums</a></li>
</ul></li>
</ul>

            
                <div class="docs-footer-grid">
                <div class="footer-bg-break docs-footer-break">
<div class="footer-container-break">
    <div class="footer-left-break">
      <p>View the <a href="http://www14.software.ibm.com/cgi-bin/weblap/lap.pl?li_formnum=L-MCAE-ATLKDW&title=IBM%20Blockchain%20Platform:%20Develop">license information</a></p>
    </div>
</div>
</div>

                </div>
          </nav>
        </div>
        <div class="page-content-grid">
          <section class="content-chunk">
            <!-- <a class="toggle open" href="#nav">open</a> -->
            
              <h1 id="queries-tutorial-using-the-composer-query-language-and-rest-apis">Queries Tutorial using the Composer Query language and REST APIs</h1>

<p>In this tutorial, we will build on the <a href="./developer-tutorial.html">developer tutorial</a>, extending it to demonstrate  queries. The native  query language can filter results returned using criteria and can be invoked in transactions to perform operations, such as updating or removing assets on result sets.</p>

<p>Queries are defined in a query file (<code>.qry</code>) in the parent directory of the business network definition. Queries contain a WHERE clause, which defines the criteria by which assets or participants are selected.</p>

<p>This tutorial uses the <code>tutorial-network</code> business network developed and deployed in the <a href="developer-tutorial.html">Developer-Tutorial</a>.</p>

<h2 id="prerequisites">Prerequisites</h2>

<p>Before beginning this tutorial:</p>

<ul>
<li>Complete the <a href="../installing/development-tools.html">development environment installation</a>.</li>
<li>Complete the <a href="./developer-tutorial.html">developer tutorial</a>.</li>
</ul>

<h2 id="step-one-updating-the-business-network">Step One: Updating the business network</h2>

<p>The business network created in the developer tutorial must be updated. The updated business network contains two events and an additional transactions.</p>

<h4 id="update-the-model-file">Update the model file</h4>

<p>The model file must be updated to contain events and a new transaction.</p>

<ol>
<li><p>Open the model (<code>.cto</code>) file for the <code>tutorial-network</code>.</p></li>
<li><p>Add the following events and transaction to the model:</p>
<div class="highlight"><pre><code class="language-" data-lang="">event TradeNotification {
    --&gt; Commodity commodity
}

transaction RemoveHighQuantityCommodities {
}

event RemoveNotification {
    --&gt; Commodity commodity
}
</code></pre></div></li>
<li><p>Save the changes to your model.</p></li>
</ol>

<h4 id="update-transaction-logic-to-use-queries-and-events">Update transaction logic to use queries and events</h4>

<p>Now that the domain model has been updated, we can write the additional business logic that gets executed when a transaction is submitted for processing. In this tutorial we have added events and queries to the business logic below.</p>

<ol>
<li><p>Open the transaction processor function file <code>lib/logic.js</code>.</p></li>
<li><p>Replace the transaction logic with the following JavaScript:</p>
<div class="highlight"><pre><code class="language-" data-lang=""><span class="sd">/**
 * Track the trade of a commodity from one trader to another
 * @param {org.example.mynetwork.Trade} trade - the trade to be processed
 * @transaction
 */</span>
<span class="k">async</span> <span class="k">function</span> <span class="nf">tradeCommodity</span><span class="p">(</span><span class="nx">trade</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// set the new owner of the commodity</span>
    <span class="nx">trade</span><span class="o">.</span><span class="nx">commodity</span><span class="o">.</span><span class="nx">owner</span> <span class="o">=</span> <span class="nx">trade</span><span class="o">.</span><span class="nx">newOwner</span><span class="p">;</span>
    <span class="nx">let</span> <span class="nx">assetRegistry</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getAssetRegistry</span><span class="p">(</span><span class="s1">'org.example.mynetwork.Commodity'</span><span class="p">);</span>

    <span class="c1">// emit a notification that a trade has occurred</span>
    <span class="nx">let</span> <span class="nx">tradeNotification</span> <span class="o">=</span> <span class="nx">getFactory</span><span class="p">()</span><span class="o">.</span><span class="nx">newEvent</span><span class="p">(</span><span class="s1">'org.example.mynetwork'</span><span class="p">,</span> <span class="s1">'TradeNotification'</span><span class="p">);</span>
    <span class="nx">tradeNotification</span><span class="o">.</span><span class="nx">commodity</span> <span class="o">=</span> <span class="nx">trade</span><span class="o">.</span><span class="nx">commodity</span><span class="p">;</span>
    <span class="nx">emit</span><span class="p">(</span><span class="nx">tradeNotification</span><span class="p">);</span>

    <span class="c1">// persist the state of the commodity</span>
    <span class="k">await</span> <span class="nx">assetRegistry</span><span class="o">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">trade</span><span class="o">.</span><span class="nx">commodity</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/**
 * Remove all high volume commodities
 * @param {org.example.mynetwork.RemoveHighQuantityCommodities} remove - the remove to be processed
 * @transaction
 */</span>
<span class="k">async</span> <span class="k">function</span> <span class="nf">removeHighQuantityCommodities</span><span class="p">(</span><span class="nx">remove</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">let</span> <span class="nx">assetRegistry</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getAssetRegistry</span><span class="p">(</span><span class="s1">'org.example.mynetwork.Commodity'</span><span class="p">);</span>
    <span class="nx">let</span> <span class="nx">results</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">query</span><span class="p">(</span><span class="s1">'selectCommoditiesWithHighQuantity'</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">let</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">n</span> <span class="o">&lt;</span> <span class="nx">results</span><span class="o">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">let</span> <span class="nx">trade</span> <span class="o">=</span> <span class="nx">results</span><span class="p">[</span><span class="nx">n</span><span class="p">];</span>

        <span class="c1">// emit a notification that a trade was removed</span>
        <span class="nx">let</span> <span class="nx">removeNotification</span> <span class="o">=</span> <span class="nx">getFactory</span><span class="p">()</span><span class="o">.</span><span class="nx">newEvent</span><span class="p">(</span><span class="s1">'org.example.mynetwork'</span><span class="p">,</span><span class="s1">'RemoveNotification'</span><span class="p">);</span>
        <span class="nx">removeNotification</span><span class="o">.</span><span class="nx">commodity</span> <span class="o">=</span> <span class="nx">trade</span><span class="p">;</span>
        <span class="nx">emit</span><span class="p">(</span><span class="nx">removeNotification</span><span class="p">);</span>
        <span class="k">await</span> <span class="nx">assetRegistry</span><span class="o">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">trade</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></li>
<li><p>Save your changes to <code>logic.js</code>.</p></li>
</ol>

<p>The first function <code>tradeCommodity</code> will change the owner property on a commodity (with a new owner Participant) on an incoming Trade transaction and emit a Notification event to that effect. It then persists the modified Commodity back into the asset registry which is used to store Commodity instances.</p>

<p>The second function calls a named query &#39;selectCommoditiesWithHighQuantity&#39; (defined in <code>queries.qry</code>) which will return all Commodity asset records that have a quantity &gt; 60 ; emit an event ; and remove the Commodity from the AssetRegistry.</p>

<h2 id="step-two-create-a-query-definition-file">Step Two: Create a query definition file</h2>

<p>The queries used by the Transaction Processor logic are defined in a file which must be called <code>queries.qry</code>. Each query entry defines the resources and criteria against which the query is executed.</p>

<ol>
<li><p>In the <code>tutorial-network</code> directory, create a new file called <code>queries.qry</code>.</p></li>
<li><p>Copy and paste the following code into <code>queries.qry</code>:</p>
<div class="highlight"><pre><code class="language-" data-lang="">/** Sample queries for Commodity Trading business network
*/

query selectCommodities {
  description: "Select all commodities"
  statement:
      SELECT org.example.mynetwork.Commodity
}

query selectCommoditiesByExchange {
  description: "Select all commodities based on their main exchange"
  statement:
      SELECT org.example.mynetwork.Commodity
          WHERE (mainExchange==_$exchange)
}

query selectCommoditiesByOwner {
  description: "Select all commodities based on their owner"
  statement:
      SELECT org.example.mynetwork.Commodity
          WHERE (owner == _$owner)
}

query selectCommoditiesWithHighQuantity {
  description: "Select commodities based on quantity"
  statement:
      SELECT org.example.mynetwork.Commodity
          WHERE (quantity &gt; 60)
}
</code></pre></div></li>
<li><p>Save your changes to <code>queries.qry</code>.</p></li>
</ol>

<h2 id="step-three-regenerate-your-business-network-archive">Step Three: Regenerate your business network archive</h2>

<p>After changing the files in a business network, the business network must be repackaged as a business network archive (<code>.bna</code>) and redeployed to the Hyperledger Fabric instance. Upgrading a deployed network requires that the new version being deployed have a new version number.</p>

<ol>
<li><p>In the <code>tutorial-network</code> directory, open the <code>package.json</code> file.</p></li>
<li><p>Update the <strong>version</strong> property from <code>0.0.1</code> to <code>0.0.2</code>.</p></li>
<li><p>Using the command line, navigate to the <code>tutorial-network</code> directory.</p></li>
<li><p>Run the following command:</p>
<div class="highlight"><pre><code class="language-" data-lang="">composer archive create --sourceType dir --sourceName . -a tutorial-network@0.0.2.bna
</code></pre></div></li>
</ol>

<h2 id="step-four-deploy-the-updated-business-network-definition">Step Four: Deploy the updated business network definition</h2>

<p>We need to deploy the modified network to become the latest edition on the blockchain! We are using the newly created archive business network archive file to update the existing deployed business network; this is the same business network name, that we used during the Developer Tutorial.</p>

<ol>
<li><p>Switch to the terminal, change directory to the folder containing the <code>tutorial-network@0.0.2.bna</code>.</p></li>
<li><p>Run the following command to install the updated business network:</p>
<div class="highlight"><pre><code class="language-" data-lang="">composer network install --card PeerAdmin@hlfv1 --archiveFile tutorial-network@0.0.2.bna
</code></pre></div></li>
<li><p>Run the following command to upgrade the network to the new version:</p>
<div class="highlight"><pre><code class="language-" data-lang="">composer network upgrade -c PeerAdmin@hlfv1 -n tutorial-network -V 0.0.2
</code></pre></div></li>
<li><p>Check the current version of the business network before continuing by using the following command:</p>
<div class="highlight"><pre><code class="language-" data-lang="">composer network ping -c admin@tutorial-network | grep Business
</code></pre></div></li>
</ol>

<h2 id="step-five-regenerate-the-rest-apis-for-the-updated-business-network">Step Five: Regenerate the REST APIs for the updated Business Network</h2>

<p>We will now integrate the newly updated business network with queries added, and expose the REST APIs for this business network.</p>

<ol>
<li><p>Using the command line, navigate to the <code>tutorial-network</code> directory.</p></li>
<li><p>Use the following command to launch the REST server:</p>
<div class="highlight"><pre><code class="language-" data-lang="">composer-rest-server
</code></pre></div></li>
<li><p>Enter <code>admin@tutorial-network</code> as the card name.</p></li>
<li><p>Select <strong>never use namespaces</strong> when asked whether to use namespaces in the generated API.</p></li>
<li><p>Select <strong>No</strong> when asked whether to secure the generated API.</p></li>
<li><p>Select <strong>Yes</strong> when asked whether to enable event publication.</p></li>
<li><p>Select <strong>No</strong> when asked whether to enable TLS security.</p></li>
</ol>

<h2 id="step-six-test-the-rest-apis-and-create-some-data">Step Six: Test the REST APIs and create some data</h2>

<p>Open a web browser and navigate to <a href="http://localhost:3000/explorer" target="blank">http://<span></span>localhost:3000/explorer</a> . You should see the LoopBack API Explorer, allowing you to inspect and test the generated REST API.</p>

<p>We should be able to see that the REST Endpoint called &#39;Query&#39; has been added and, upon expanding, reveals the list of REST Query operations defined in the business network <code>tutorial-network</code></p>

<p><img src="../assets/img/tutorials/query/rest-explorer-discover.png" alt="Queries exposed as REST Endpoints"></p>

<p>Before we proceed, we need to create some data, to demonstrate queries adequately. Using the sample JSON data provided, create 3 Traders (Participants)and some more Commodities (Assets) using the REST APIs.</p>

<ol>
<li><p>First, click on &#39;Trader&#39; in the REST Explorer, then click on the &#39;POST&#39; method on /Trader, then scroll down to the Parameter section - create the following Trader instances, in turn:</p>
<div class="highlight"><pre><code class="language-" data-lang="">{
  "$class": "org.example.mynetwork.Trader",
  "tradeId": "TRADER1",
  "firstName": "Jenny",
  "lastName": "Jones"
}
</code></pre></div></li>
<li><p>Click &#39;Try it out&#39; to create the Participant. The &#39;Response Code&#39; (scroll down) should be 200 (SUCCESS)</p></li>
<li><p>Create another trader by copying the following JSON:</p>
<div class="highlight"><pre><code class="language-" data-lang="">{
  "$class": "org.example.mynetwork.Trader",
  "tradeId": "TRADER2",
  "firstName": "Jack",
  "lastName": "Sock"
}
</code></pre></div></li>
<li><p>Create a third trader by coping the following JSON:</p>
<div class="highlight"><pre><code class="language-" data-lang="">{
  "$class": "org.example.mynetwork.Trader",
  "tradeId": "TRADER3",
  "firstName": "Rainer",
  "lastName": "Valens"
}
</code></pre></div></li>
<li><p>Now scroll up to the top and click on &#39;Commodity&#39; object in the REST Explorer.</p></li>
<li><p>Click on the POST operation and scroll down to the Parameters section: In the same way as above, create two Commodity Asset records (see below) for owners TRADER1 and TRADER2:</p></li>
</ol>
<div class="highlight"><pre><code class="language-" data-lang="">{
  "$class": "org.example.mynetwork.Commodity",
  "tradingSymbol": "EMA",
  "description": "Corn",
  "mainExchange": "EURONEXT",
  "quantity": 10,
  "owner": "resource:org.example.mynetwork.Trader#TRADER1"
}
</code></pre></div><div class="highlight"><pre><code class="language-" data-lang="">{
  "$class": "org.example.mynetwork.Commodity",
  "tradingSymbol": "CC",
  "description": "Cocoa",
  "mainExchange": "ICE",
  "quantity": 80,
  "owner": "resource:org.example.mynetwork.Trader#TRADER2"
}
</code></pre></div>
<h2 id="step-seven-perform-queries-using-the-commodity-trading-rest-api-explorer">Step Seven: Perform queries using the commodity trading REST API explorer</h2>

<p>Now that we have some Assets and Participants, we can test out some queries using the generated Query REST operations.</p>

<h4 id="perform-a-simple-rest-query">Perform a simple REST query</h4>

<p>Now that we have assets and participants, we can try out some queries.</p>

<p>The simplest REST query we can try out first is our named query <code>selectCommodities</code>.</p>

<p>Expand the &#39;Query&#39; REST Endpoint and you will see the named queries we defined in our model.</p>

<p>These queries are now exposed as REST queries and for which a /GET operation is generated, Note that the description of the query (that we defined in our model definition) is shown on the right hand side.</p>

<p><img src="../assets/img/tutorials/query/commodity-rest-endpointhdr.png" alt="Commodities: REST Endpoint"></p>

<ol>
<li><p>Expand the <code>selectCommodities</code> query.</p></li>
<li><p>Click the &#39;Try it Out&#39; button.</p></li>
</ol>

<p><img src="../assets/img/tutorials/query/query-select-commodities.png" alt="Setup REST query: select all Commodities"></p>

<p>It will return all existing Commodities - there should be 2 assets returned.</p>

<p><img src="../assets/img/tutorials/query/query-commodity-results.png" alt="Query Results: All Commodities"></p>

<h3 id="perform-filtered-rest-queries">Perform Filtered REST Queries</h3>

<p>Let&#39;s select all Commodities by their Exchange - for example &#39;EURONEXT&#39; main exchange.</p>

<ol>
<li><p>Expand query Endpoint &#39;selectCommoditiesByExchange&#39; and scroll to the &#39;Parameters&#39; section.</p></li>
<li><p>Enter &#39;EURONEXT&#39; in the &#39;Exchange&#39; parameter.</p></li>
<li><p>Click &#39;Try it Out&#39;.</p></li>
</ol>

<p><img src="../assets/img/tutorials/query/query-selectby-exchange.png" alt="Setup REST query by Exchange"></p>

<p>The results reveal that only those Commodities with an Exchange of &#39;EURONEXT&#39; are shown in the response body</p>

<p><img src="../assets/img/tutorials/query/queryresults-selectby-exchange.png" alt="Query Results: Commodities by exchange"></p>

<h3 id="perform-transaction-update-using-results-from-named-query">Perform Transaction update using results from named Query</h3>

<p>Finally, you will recall we had defined a simple query that filters Commodities with a Quantity greater than 60 in our query file. Queries are very powerful, when used in transaction functions, as using queries allows transaction logic to set up the set of assets or participants to perform updates on, or for creating remove actions for example.</p>

<p><img src="../assets/img/tutorials/query/querydef-recall-high-qty-commodities.png" alt="Recollect Query definition"></p>

<p>We use the <code>selectCommoditiesWithHighQuantity</code> query in the <code>removeHighQuantityCommodities</code> transaction. If you execute this /GET operation in the REST Explorer, you&#39;ll see it selects only those assets greater than 60 in quantity.</p>

<p><img src="../assets/img/tutorials/query/functiondef-recall-high-qty-commodities.png" alt="Recollect Transaction logic using query"></p>

<p>Now let&#39;s use the query to perform a removal of high quantity Commodities.</p>

<p>First check for yourself how many Commodities are present (use the &#39;Commodity&#39; /GET operation) and you should see at least two Commodities, one of which (Cocoa) has a quantity &gt; 60.</p>

<p><img src="../assets/img/tutorials/query/commodity-rest-endpointhdr.png" alt="Commodity REST Endpoint">
<img src="../assets/img/tutorials/query/txn-query-commodity-pre-rm.png" alt="Results prior to &#39;Removal transaction&#39; invocation"></p>

<p>Let&#39;s check out the actual query, by clicking on the REST Endpoint <code>/selectCommoditiesWithHighQuantity</code> and click /GET then scroll down to &#39;Try it Out&#39; - there should be one Commodity that meets the criteria.</p>

<p><img src="../assets/img/tutorials/query/query-selectby-comm-high-qty.png" alt="Query Commodities with High Quantities"></p>

<p>OK. Now let&#39;s execute a REST transaction, that uses our &#39;High Quantity&#39; query definition to decide which Commodities to remove.</p>

<p>Click on the RemoveHighQuantityCommodities REST Endpoint to reveal the /POST operation for same.</p>

<p><img src="../assets/img/tutorials/query/txn-show-rm-comm-high-qty.png" alt="Show RemoveHighQuantityCommodities Endpoint"></p>

<p>Click on POST, scroll down to the Parameter section and click &#39;Try it Out&#39; - note: you do <em>not</em> have to enter any data in the &#39;data&#39; section.</p>

<p>Scroll down and you should see a transactionId which represents the &#39;remove&#39; invocation (itself a blockchain transaction) inside of the transaction processor function and which will update the world state - the Response Code should be 200</p>

<p><img src="../assets/img/tutorials/query/txn-exec-rm-comm-high-qty.png" alt="Carry out &#39;High Quantity&#39; removal transaction"></p>

<p>Finally, let&#39;s verify our Commodities status. Return to the &#39;Commodity&#39; REST Operations and once again perform a /GET operation....&#39;Try it Out&#39;.</p>

<p>The results should show that the Commodity asset &#39;Cocoa&#39; has now gone, ie only those Commodity assets with a quantity &lt;= 60 still remain, ie asset &#39;Corn&#39; in our example. The named query fed the transaction update (to remove high quantity Commodities) and which was executed in business logic.</p>

<p><img src="../assets/img/tutorials/query/txn-query-commodities-post-rm.png" alt="Final results of query-driven transaction function"></p>

<h1 id="congratulations">Congratulations!</h1>

<p>Well done, you&#39;ve now completed this tutorial and we hope you now have a much better idea of the power of queries in Composer. You can start creating/building your own queries (or modifying the existing queries and adding associated data to this business network - note: you would need to re-deploy any query changes) to try out!</p>

<h2 id="related-links">Related Links</h2>

<ul>
<li><a href="developer-tutorial.html">Developer-Tutorial</a></li>
<li><a href="../business-network/bnd-deploy.html">Deploying a business network</a></li>
</ul>

            
          </section>
        </div>
        <!-- Otherwise, have the main content fill all 12 columns... -->
        
      <div class="PageNavigation">
    
    
  </div>
    </article>
</div>
<script>
(function (document) {
    function clipboard_init() {
        var charts = document.querySelectorAll("div.highlight"),
            arr = [],
            i, j, maxItem, pre, btn, el;

        // Make sure we are dealing with an array
        for(i = 0, maxItem = charts.length; i < maxItem; i++) arr.push(charts[i]);

        // Find the UML source element and get the text
        for (i = 0, maxItem = arr.length; i < maxItem; i++) {
            el = arr[i];
            pre = el.childNodes[0];

            pre.id = "hl_code" + i.toString();
            btn = document.createElement('copy-button');
            btn.appendChild(document.createTextNode('Copy'));
            btn.setAttribute("class", "copy-btn");
            btn.setAttribute("data-clipboard-target", "#hl_code" + i.toString());
            el.insertBefore(btn, pre);
        }
        new Clipboard('.copy-btn');
    };

    function onReady(fn) {
        if (document.addEventListener) {
            document.addEventListener('DOMContentLoaded', fn);
        } else {
            document.attachEvent('onreadystatechange', function() {
                if (document.readyState === 'interactive')
                    fn();
            });
        }
    }

    onReady(function(){
        clipboard_init();
    });
})(document);
</script>
<script src="/develop/assets/js/nav.js"></script>
<script src="/develop/assets/js/search_bar.js"></script>

    

    


  </div>
</body>
</html>
